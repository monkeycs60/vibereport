- Always document and update MD files when adding/moddying a feature or using a new service
- Always be sure to delete dead code after replacing/refactoring it
- Always run tests after important changes and fix them if not green

# Vibereport

Rust CLI tool. "The Spotify Wrapped for your code."

## Conventions
- Use `thiserror` pattern for errors (enum VibereportError)
- All git operations go through `gix` crate, never shell out to `git` (exception: `scanner/remote.rs` uses system git for shallow clone — gix lacks `--depth` support)
- Module structure: git/, project/, score/, render/
- Tests: unit tests in same file (#[cfg(test)] mod tests), integration tests in tests/
- Run tests: `cargo test`
- Run lints: `cargo clippy -- -D warnings`
- Format: `cargo fmt`

## Architecture
- src/git/ — git log parsing, AI commit detection, timeline
- src/git/ai_detect.rs — AI tool detection from commit messages (6 tools)
- src/git/parser.rs — git history analysis via gix + repo fingerprint
- src/git/timeline.rs — monthly commit aggregation (AI evolution over time)
- src/project/ — dependency counting, test detection, language stats, vibe detection
- src/project/security.rs — .env detection (8 patterns), hardcoded secrets scanning
- src/project/vibe_detect.rs — linting, CI/CD, boomer AI, node_modules, gitignore, readme, TODO flood, single branch, mega commit
- src/score/ — composite Vibe Score calculation (uncapped, S+ for >100), contextual roasts
- src/render/ — terminal output (ASCII timeline chart), SVG export, JSON export
- src/share/ — upload to vibereport.dev API (share by default, --no-share to opt out)
- src/scanner/ — multi-repo discovery (--scan-all) + remote GitHub clone
- web/api/ — Cloudflare Workers + Hono + D1 backend (deployed at vibereport-api.clement-serizay.workers.dev)
- web/frontend/ — Astro SSR + Tailwind frontend on Vercel (https://vibereport.vercel.app/)
- vps-worker/ — Axum HTTP server for VPS scanning (deployed on 137.74.43.81)

## AI Tool Detection
Detection is based on commit message signatures (Co-Authored-By trailers, email patterns, message prefixes).

Detected tools:
- **Claude Code**: `Co-authored-by: Claude`, `noreply@anthropic.com`, `Generated with Claude Code`
- **Cursor**: `Co-authored-by: Cursor`
- **Aider**: `Co-authored-by: aider`, `noreply@aider.chat`, `aider:` prefix
- **Codex CLI**: `Co-authored-by: Codex`, `Generated by Codex`, `codex-cli`
- **GitHub Copilot**: `Co-authored-by: copilot`, `github-copilot`
- **Gemini CLI**: `Co-authored-by: Gemini`, `noreply@google.com` + gemini

Tools that do NOT sign commits (not detectable): Windsurf/Codeium, Copilot inline autocomplete, Kilo Code.

## Scan Modes
1. Single repo (default): `vibereport` or `vibereport /path/to/repo`
2. Multi-repo: `vibereport --scan-all ~/projects` — finds all git repos recursively
3. Remote GitHub: `vibereport github:user/repo` — shallow clone to /tmp, auto-cleanup
4. Web scan: POST /api/scan — parallel GitHub API fetching, up to ~100k commits per repo

## Scoring (Vibe Score — composite, basis for grade S+ to F)
- AI ratio: 0-60 points (dominant factor)
- No tests: +20 / Few tests (<3): +10
- .env in git: +20/file (max 60)
- Hardcoded secrets: +20/each (max 60)
- Dependencies bloat: 0-10 points
- No linting: +10 / No CI/CD: +10
- Boomer AI (AI% > 0 but no .claude/, .cursorrules, AGENTS.md etc.): +10
- node_modules in git: +15 / Mega commit: +10
- No .gitignore: +10 / No README: +10
- TODO flood (>20): +5 / Single branch: +5
- Score is UNCAPPED — can exceed 100 for S+ grade
- **AI%** is separate factual metric: `ai_commits / total_commits * 100`

## Domain & Web Stack
- **Domain**: vibereport.dev (Cloudflare Registrar)
- **Frontend**: Astro SSR on Vercel + Tailwind (Tokyo Night theme) — https://vibereport.vercel.app/ (will move to vibereport.dev)
- **API**: Cloudflare Workers + Hono + D1 (SQLite) — https://vibereport-api.clement-serizay.workers.dev
- **VPS Worker**: Axum HTTP server on OVH VPS — https://scan.vibereport.dev (Cloudflare Tunnel)
- **Database**: Cloudflare D1 (vibereport-db), schema in web/api/schema.sql
- **GitHub token**: stored as Worker secret (GITHUB_TOKEN) for 5000 req/hr rate limit
- **VPS auth**: Bearer token (VPS_AUTH_TOKEN secret on CF Worker)
- **Deploy API**: `cd web/api && npx wrangler deploy`
- **Deploy frontend**: push to GitHub (Vercel auto-deploys from master)
- **Deploy VPS**: ssh ubuntu@vps-139a77b3.vps.ovh.net, cd ~/vibereport, git pull, cargo build --release, sudo systemctl restart vibereport-worker

## VPS Scan Worker
- POST /scan endpoint on port 3001, exposed via Cloudflare Tunnel at https://scan.vibereport.dev
- Named tunnel: `vibereport-scan` (ID: 1c244fbe-83cf-4435-aadb-b5fb09f7c9cd)
- Auth: `Authorization: Bearer {VPS_AUTH_TOKEN}`
- Clones repos with `git clone --bare --shallow-since`, runs `vibereport --json`
- Concurrency: semaphore (5 concurrent clones)
- systemd services: vibereport-worker (Axum) + cloudflared-tunnel (Cloudflare Tunnel)
- CF Worker proxies to VPS first, falls back to GitHub API if VPS is down
- Config: ~/.cloudflared/config.yml on VPS

## Key Design Decisions
- Share by default (--no-share to opt out) for maximum leaderboard participation
- Repo fingerprint (first_commit_sha:remote_url) for deduplication / upsert
- Parallel GitHub API fetching (20 concurrent pages) for scanning all commits
- Trends use reports table (deduplicated) not scan_history for consistent averages
- VPS scanning for full vibe detection (chaos badges) — GitHub API fallback for basic scans
