- Always document and update MD files when adding/moddying a feature or using a new service
- Always be sure to delete dead code after replacing/refactoring it
- Always run tests after important changes and fix them if not green
- On CLI changes: bump version in Cargo.toml, `git tag -a vX.Y.Z -m "vX.Y.Z"`, push tag (triggers GitHub Actions release build), then `cargo publish -p vibereport`

# Vibereport

Rust CLI tool. "The Spotify Wrapped for your code."

## Conventions
- Use `thiserror` pattern for errors (enum VibereportError)
- All git operations go through `gix` crate, never shell out to `git` (exception: `scanner/remote.rs` uses system git for shallow clone — gix lacks `--depth` support)
- Module structure: git/, project/, score/, render/
- Tests: unit tests in same file (#[cfg(test)] mod tests), integration tests in tests/
- Run tests: `cargo test`
- Run lints: `cargo clippy -- -D warnings`
- Format: `cargo fmt`

## Architecture
- src/git/ — git log parsing, AI commit detection, timeline
- src/git/ai_detect.rs — AI tool detection from commit messages (6 tools)
- src/git/parser.rs — git history analysis via gix + repo fingerprint
- src/git/timeline.rs — monthly commit aggregation (AI evolution over time)
- src/project/ — dependency counting, test detection, language stats, vibe detection
- src/project/security.rs — .env detection (8 patterns), hardcoded secrets scanning
- src/project/vibe_detect.rs — linting, CI/CD, boomer AI, node_modules, gitignore, readme, TODO flood, single branch, mega commit
- src/score/ — composite Vibe Score calculation (uncapped, S+ for >100), contextual roasts
- src/render/ — terminal output (ASCII timeline chart), SVG export, JSON export
- src/share/ — upload to vibereport.dev API (share by default, --no-share to opt out)
- src/scanner/ — multi-repo discovery (--scan-all) + remote GitHub clone
- web/api/ — Cloudflare Workers + Hono + D1 backend (deployed at vibereport-api.clement-serizay.workers.dev)
- web/frontend/ — Astro SSR + Tailwind frontend on Vercel (https://vibereport.dev)
- vps-worker/ — Axum HTTP server for VPS scanning (deployed on 137.74.43.81)

## AI Tool Detection
Detection is based on commit message signatures (Co-Authored-By trailers, email patterns, message prefixes).

Detected tools:
- **Claude Code**: `Co-authored-by: Claude`, `noreply@anthropic.com`, `Generated with Claude Code`
- **Cursor**: `Co-authored-by: Cursor`
- **Aider**: `Co-authored-by: aider`, `noreply@aider.chat`, `aider:` prefix
- **Codex CLI**: `Co-authored-by: Codex`, `Generated by Codex`, `codex-cli`
- **GitHub Copilot**: `Co-authored-by: copilot`, `github-copilot`
- **Gemini CLI**: `Co-authored-by: Gemini`, `noreply@google.com` + gemini

Tools that do NOT sign commits (not detectable): Windsurf/Codeium, Copilot inline autocomplete, Kilo Code.

## Scan Modes
1. Single repo (default): `vibereport` or `vibereport /path/to/repo`
2. Multi-repo: `vibereport --scan-all ~/projects` — finds all git repos recursively
3. Remote GitHub: `vibereport github:user/repo` — shallow clone to /tmp, auto-cleanup
4. Web scan: POST /api/scan — parallel GitHub API fetching, capped at 50 pages (~5k commits) per web scan, 10-min cache per repo

## Scoring (Vibe Score — composite, basis for grade S+ to F)
- AI ratio: 0-60 points (dominant factor)
- No tests: +20 / Few tests (<3): +10
- .env in git: +20/file (max 60)
- Hardcoded secrets: +20/each (max 60)
- Dependencies bloat: 0-10 points
- No linting: +10 / No CI/CD: +10
- Boomer AI (AI% > 0 but no .claude/, .cursorrules, AGENTS.md etc.): +10
- node_modules in git: +15 / Mega commit: +10
- No .gitignore: +10 / No README: +10
- TODO flood (>20): +5 / Single branch: +5
- Score is UNCAPPED — can exceed 100 for S+ grade
- **AI%** is separate factual metric: `ai_commits / total_commits * 100`

## Domain & Web Stack
- **Domain**: vibereport.dev (Cloudflare Registrar)
- **Frontend**: Astro SSR on Vercel + Tailwind (Tokyo Night theme) — https://www.vibereport.dev
- **API**: Cloudflare Workers + Hono + D1 (SQLite) — https://vibereport-api.clement-serizay.workers.dev
- **VPS Worker**: Axum HTTP server on OVH VPS — https://scan.vibereport.dev (Cloudflare Tunnel)
- **Database**: Cloudflare D1 (vibereport-db), schema in web/api/schema.sql
- **GitHub token**: stored as Worker secret (GITHUB_TOKEN) for 5000 req/hr rate limit
- **VPS auth**: Bearer token (VPS_AUTH_TOKEN secret on CF Worker)
- **Deploy API**: `cd web/api && npx wrangler deploy`
- **Deploy frontend**: push to GitHub (Vercel auto-deploys from master)
- **Deploy VPS**: ssh ubuntu@vps-139a77b3.vps.ovh.net, cd ~/vibereport, git pull, cargo build --release, sudo systemctl restart vibereport-worker

## VPS Scan Worker
- POST /scan — user web scans (semaphore: 2 concurrent)
- POST /index-scan — daily index cron scan (semaphore: 3 concurrent, fire-and-forget via tokio::spawn)
- Port 3001, binds to 127.0.0.1, exposed via Cloudflare Tunnel at https://scan.vibereport.dev
- Named tunnel: `vibereport-scan` (ID: 1c244fbe-83cf-4435-aadb-b5fb09f7c9cd)
- Auth: `Authorization: Bearer {VPS_AUTH_TOKEN}` (constant-time comparison)
- Env vars: `AUTH_TOKEN` (required), `API_URL` (default: vibereport-api worker URL), `VIBEREPORT_BIN`, `PORT`
- Clones repos with `git clone --bare --shallow-since`, runs `vibereport --json`
- Clone timeout: 120s, analysis timeout: 60s (prevents massive repos from blocking slots)
- systemd services: vibereport-worker (Axum) + cloudflared-tunnel (Cloudflare Tunnel)
- CF Worker proxies to VPS first, falls back to GitHub API if VPS is down
- Config: ~/.cloudflared/config.yml on VPS

## GitHub AI Index
- 1000 repos selected per quarter (600 by stars + 600 by activity, deduped, cut to 1000)
- Panel stored in `index_panel` table, fixed per quarter for trend comparability
- Panel generation: `scripts/generate-panel.sh` (uses GitHub Search API, ~12 requests) — stars query filters `pushed:>2025-06-01` to exclude dead repos
- Current results: 891/1000 repos active, ~628K commits, ~15K AI, ~2.39% AI
- Daily cron at 3h UTC: CF Worker triggers VPS → VPS scans all panel repos → POSTs results back
- Results stored in `index_scans` (per-repo) and `index_snapshots` (daily aggregates)
- D1 tables: `index_panel`, `index_scans`, `index_snapshots`
- API endpoints: GET /api/index-panel, POST /api/index-results, GET /api/index-latest, GET /api/index-trend
- Frontend: BattleChart shows index-only (no toggle), TrendChart shows stacked area
- Index and Community data pools are completely independent — no cross-contamination
- Design doc: docs/plans/2026-02-21-github-ai-index-design.md

## Frontend
- Homepage: 5 sections — hero, battle, trend, leaderboard, CTA
- BattleChart: index-only (no toggle), 4 props: aiCommits, humanCommits, totalRepos, snapshotDate
- TrendChart: stacked area chart with dynamic Y-axis, snapshots prop, auto-scales to data
- Navigation: 4 links — scan, leaderboard, trends, github
- /reports page deleted, merged into /leaderboard
- Leaderboard: configurable sort (AI% or Vibe Score), Score column added
- Scan page: AI% as hero metric, Vibe Score secondary
- Report page: AI% as hero, Vibe Score + Grade secondary
- Trends page: index stacked area (primary) + community section (secondary)

## Distribution
- **Install scripts**: `web/frontend/public/install.sh` (Unix) + `web/frontend/public/install.ps1` (Windows), served at vibereport.dev/install.sh and vibereport.dev/install.ps1
- **Install (Unix)**: `curl -fsSL https://vibereport.dev/install.sh | sh`
- **Install (Windows)**: `irm https://vibereport.dev/install.ps1 | iex`
- **Install (cargo)**: `cargo install vibereport`
- **GitHub Releases**: tag `vX.Y.Z` triggers `.github/workflows/release.yml` → builds 4 targets (linux-x64, macos-x64, macos-arm64, windows-x64) → uploads `.tar.gz`/`.zip` to release
- **crates.io**: `cargo publish -p vibereport` (vps-worker has `publish = false`)
- **Release flow**: bump version in Cargo.toml → commit → `git tag -a vX.Y.Z -m "vX.Y.Z"` → `git push origin vX.Y.Z` → wait for CI → `cargo publish -p vibereport`

## Key Design Decisions
- Share by default (--no-share to opt out) for maximum leaderboard participation
- Repo fingerprint (first_commit_sha:remote_url) for deduplication / upsert — credentials stripped from URL before fingerprinting
- Parallel GitHub API fetching (20 concurrent pages) for scanning all commits
- Trends use reports table (deduplicated) not scan_history for consistent averages
- VPS scanning for full vibe detection (chaos badges) — GitHub API fallback for basic scans

## Security Hardening
- **VPS Worker**: repo URLs validated against strict GitHub regex (no SSRF), `since` validated as YYYY-MM-DD, constant-time token comparison (subtle crate), binds to 127.0.0.1 only, git stderr never leaked to caller, `api_url` hardcoded via `API_URL` env var (not from request body)
- **API**: IP-based rate limiting (5 scans/min, 10 reports/min, 60 reads/min via CF-Connecting-IP), server-side re-derivation of score_grade/roast (client values ignored), chaos_badges validated against allowlist, input length limits on all string fields, scan_date validated, web scans capped at 50 pages (WEB_MAX_PAGES), 10-min scan cache per repo, generic error messages (no internal details leaked)
- **CORS**: only `vibereport.dev` and `www.vibereport.dev` allowed (no wildcard *.vercel.app)
- **Frontend**: all innerHTML replaced with textContent/createElement for API data (XSS prevention), URL params allowlisted before define:vars, security headers via vercel.json (X-Frame-Options DENY, X-Content-Type-Options nosniff, Referrer-Policy, Permissions-Policy)
- **CLI**: GitHub user/repo validated against `[a-zA-Z0-9_.-]+` (no path traversal), file reads capped at 1MB (OOM prevention), symlinks skipped during directory walks, credentials stripped from remote URLs in fingerprint
