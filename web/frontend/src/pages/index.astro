---
import Base from '../layouts/Base.astro';
import StatsCounter from '../components/StatsCounter.astro';
import LeaderboardTable from '../components/LeaderboardTable.astro';
import TrendChart from '../components/TrendChart.astro';
import BattleChart from '../components/BattleChart.astro';
import { fetchStats, fetchLeaderboard, fetchTrends, fetchIndexLatest, fetchIndexTrend } from '../lib/api';

let stats = { total_reports: 0, total_commits: 0, total_ai_commits: 0 };
let leaderboard = { entries: [], total: 0, page: 1, limit: 5 };
let trends = { period: '1y', trends: [] as Array<{ month: string; avg_ai_ratio: number; total_scans: number; avg_score: number; total_commits: number; ai_commits: number }> };
let indexLatest = { snapshot_date: null as string | null, quarter: '', total_repos: 0, total_commits: 0, total_ai_commits: 0, ai_percent: 0 };
let indexTrend = { snapshots: [] as Array<{ snapshot_date: string; total_repos: number; total_commits: number; total_ai_commits: number; ai_percent: number }> };

try { stats = await fetchStats(); } catch {}
try { leaderboard = await fetchLeaderboard(1, 5); } catch {}
try { trends = await fetchTrends(); } catch {}
try { indexLatest = await fetchIndexLatest(); } catch {}
try { indexTrend = await fetchIndexTrend(); } catch {}

// Community data (from trends)
const communityAiCommits = trends.trends.reduce((s, t) => s + (t.ai_commits || 0), 0);
const communityHumanCommits = trends.trends.reduce((s, t) => s + ((t.total_commits || 0) - (t.ai_commits || 0)), 0);

// Index data
const indexAiCommits = indexLatest.total_ai_commits || 0;
const indexHumanCommits = (indexLatest.total_commits || 0) - indexAiCommits;
---

<Base>
  <!-- Hero -->
  <section class="relative overflow-hidden">
    <!-- Background glow effects -->
    <div class="absolute top-0 left-1/4 w-96 h-96 bg-tokyo-cyan/5 rounded-full blur-3xl"></div>
    <div class="absolute top-20 right-1/4 w-96 h-96 bg-tokyo-green/5 rounded-full blur-3xl"></div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-16 sm:pt-24 pb-12 relative z-10">
      <div class="text-center max-w-3xl mx-auto animate-fade-in-up">
        <h1 class="text-4xl sm:text-5xl lg:text-7xl font-bold tracking-tight mb-6">
          <span class="bg-gradient-to-r from-tokyo-cyan via-tokyo-green to-tokyo-yellow bg-clip-text text-transparent">
            VIBE REPORT
          </span>
        </h1>
        <p class="text-lg sm:text-xl text-tokyo-dimmed mb-2">
          The Spotify Wrapped for your code
        </p>
        <p class="text-sm text-tokyo-dimmed/70 mb-10">
          Analyze any git repo. Discover how much was AI-generated. Get roasted.
        </p>

        <!-- Scan input -->
        <div class="max-w-xl mx-auto mb-12">
          <form
            id="hero-scan-form"
            class="flex flex-col sm:flex-row gap-3"
          >
            <div class="flex-1 relative group">
              <input
                type="text"
                id="hero-scan-input"
                placeholder="github:user/repo or paste URL"
                class="w-full px-4 py-3 bg-tokyo-surface/80 backdrop-blur border border-tokyo-border/50 rounded-lg text-sm text-tokyo-text placeholder-tokyo-dimmed/60 focus:outline-none focus:border-tokyo-cyan/50 focus:ring-1 focus:ring-tokyo-cyan/20 transition-all"
              />
            </div>
            <button
              type="submit"
              class="px-6 py-3 bg-gradient-to-r from-tokyo-cyan to-tokyo-green text-tokyo-bg font-semibold rounded-lg text-sm hover:opacity-90 active:scale-[0.98] transition-all whitespace-nowrap"
            >
              Scan repo
            </button>
          </form>
        </div>

        <!-- Quick install -->
        <div class="inline-flex items-center gap-3 px-4 py-2.5 bg-tokyo-surface/60 backdrop-blur border border-tokyo-border/30 rounded-lg">
          <code class="text-sm text-tokyo-green">$</code>
          <code class="text-sm text-tokyo-text" id="install-cmd">cargo install vibereport</code>
          <button
            id="copy-install"
            class="text-tokyo-dimmed hover:text-tokyo-cyan transition-colors"
            title="Copy to clipboard"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <section class="py-16 border-y border-tokyo-border/20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 sm:gap-12 max-w-2xl mx-auto">
        <StatsCounter
          label="Repos scanned"
          value={stats.total_reports}
          emoji="\u{1F4CA}"
        />
        <StatsCounter
          label="Commits analyzed"
          value={stats.total_commits}
          emoji="\u{26A1}"
        />
      </div>
    </div>
  </section>

  <!-- Battle Chart -->
  <section class="py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-center text-tokyo-text mb-8">
        AI vs Humans
      </h2>
      <BattleChart
        indexAiCommits={indexAiCommits}
        indexHumanCommits={indexHumanCommits}
        indexTotalRepos={indexLatest.total_repos}
        indexSnapshotDate={indexLatest.snapshot_date}
        communityAiCommits={communityAiCommits}
        communityHumanCommits={communityHumanCommits}
        communityTotalRepos={stats.total_reports}
      />
    </div>
  </section>

  <!-- Trend -->
  <section class="py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-center text-tokyo-text mb-8">
        The rise of vibe coding
      </h2>
      {indexTrend.snapshots.length >= 2 ? (
        <TrendChart trends={indexTrend.snapshots.map(s => ({
          month: s.snapshot_date,
          avg_ai_ratio: s.ai_percent / 100,
          total_scans: s.total_repos,
          total_commits: s.total_commits,
          ai_commits: s.total_ai_commits,
        }))} />
      ) : (
        <TrendChart trends={trends.trends} />
      )}
      <div class="text-center mt-4">
        <a
          href="/trends"
          class="text-sm text-tokyo-cyan hover:text-tokyo-cyan/80 transition-colors"
        >
          View full trends &rarr;
        </a>
      </div>
    </div>
  </section>

  <!-- How it works -->
  <section class="py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-center text-tokyo-text mb-12">
        How it works
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div class="text-center p-6 rounded-xl bg-tokyo-surface/30 border border-tokyo-border/20">
          <div class="text-3xl mb-3">{'\u{1F50D}'}</div>
          <h3 class="font-semibold text-tokyo-text mb-2">Scan</h3>
          <p class="text-xs text-tokyo-dimmed leading-relaxed">
            Point vibereport at any git repo. Local, remote, or via GitHub URL.
          </p>
        </div>
        <div class="text-center p-6 rounded-xl bg-tokyo-surface/30 border border-tokyo-border/20">
          <div class="text-3xl mb-3">{'\u{1F9E0}'}</div>
          <h3 class="font-semibold text-tokyo-text mb-2">Analyze</h3>
          <p class="text-xs text-tokyo-dimmed leading-relaxed">
            AI detection scans commit patterns, messages, and metadata to find generated code.
          </p>
        </div>
        <div class="text-center p-6 rounded-xl bg-tokyo-surface/30 border border-tokyo-border/20">
          <div class="text-3xl mb-3">{'\u{1F525}'}</div>
          <h3 class="font-semibold text-tokyo-text mb-2">Roast</h3>
          <p class="text-xs text-tokyo-dimmed leading-relaxed">
            Get your vibe score, letter grade, and a brutally honest roast of your codebase.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Top 5 leaderboard -->
  <section class="py-16 border-t border-tokyo-border/20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-2xl font-bold text-tokyo-text">
          Top vibers
        </h2>
        <a
          href="/leaderboard"
          class="text-sm text-tokyo-cyan hover:text-tokyo-cyan/80 transition-colors"
        >
          View all &rarr;
        </a>
      </div>
      <div class="rounded-xl border border-tokyo-border/30 bg-tokyo-surface/30 backdrop-blur-sm overflow-hidden">
        <LeaderboardTable entries={leaderboard.entries} compact={true} />
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="py-16">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <div class="p-8 rounded-2xl bg-gradient-to-br from-tokyo-surface/80 to-tokyo-surface/40 border border-tokyo-border/30 backdrop-blur-sm glow">
        <h2 class="text-xl sm:text-2xl font-bold text-tokyo-text mb-3">
          Ready to expose your codebase?
        </h2>
        <p class="text-sm text-tokyo-dimmed mb-6">
          Install the CLI to generate your vibe report and share it with the world.
        </p>
        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
          <a
            href="/scan"
            class="px-6 py-2.5 bg-gradient-to-r from-tokyo-cyan to-tokyo-green text-tokyo-bg font-semibold rounded-lg text-sm hover:opacity-90 transition-all"
          >
            Scan a repo online
          </a>
          <span class="text-tokyo-dimmed text-sm">or</span>
          <code class="px-4 py-2.5 bg-tokyo-bg rounded-lg text-sm text-tokyo-green border border-tokyo-border/30">
            cargo install vibereport
          </code>
        </div>
      </div>
    </div>
  </section>
</Base>

<script>
  // Copy install command
  document.getElementById('copy-install')?.addEventListener('click', () => {
    navigator.clipboard.writeText('cargo install vibereport');
    const btn = document.getElementById('copy-install');
    if (btn) {
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-tokyo-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      setTimeout(() => {
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>';
      }, 2000);
    }
  });

  // Hero scan form
  document.getElementById('hero-scan-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('hero-scan-input') as HTMLInputElement;
    if (input?.value.trim()) {
      window.location.href = `/scan?repo=${encodeURIComponent(input.value.trim())}`;
    }
  });
</script>
