---
import Base from '../layouts/Base.astro';
import { getApiUrl } from '../lib/api';

const apiUrl = getApiUrl();
---

<Base title="Scan a repo - vibereport" description="Analyze any GitHub repo for AI-generated code. Enter a URL and get your vibe report.">
  <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-16">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-tokyo-text mb-3">
        Scan a repo
      </h1>
      <p class="text-sm text-tokyo-dimmed">
        Enter a GitHub URL to analyze for AI-generated code.
      </p>
    </div>

    <!-- Scan form -->
    <div class="max-w-xl mx-auto mb-12">
      <form id="scan-form" class="space-y-4">
        <div class="relative">
          <input
            type="text"
            id="scan-input"
            placeholder="https://github.com/user/repo or github:user/repo"
            class="w-full px-4 py-3.5 bg-tokyo-surface/80 backdrop-blur border border-tokyo-border/50 rounded-xl text-sm text-tokyo-text placeholder-tokyo-dimmed/60 focus:outline-none focus:border-tokyo-cyan/50 focus:ring-2 focus:ring-tokyo-cyan/20 transition-all"
            autofocus
          />
        </div>
        <button
          type="submit"
          id="scan-btn"
          class="w-full px-6 py-3 bg-gradient-to-r from-tokyo-cyan to-tokyo-green text-tokyo-bg font-semibold rounded-xl text-sm hover:opacity-90 active:scale-[0.99] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Analyze
        </button>
      </form>
    </div>

    <!-- Status area -->
    <div id="scan-status" class="hidden max-w-xl mx-auto">
      <!-- Loading state -->
      <div id="scan-loading" class="hidden text-center py-12">
        <div class="inline-flex items-center gap-3 px-6 py-3 bg-tokyo-surface/50 rounded-xl border border-tokyo-border/30">
          <svg class="animate-spin h-5 w-5 text-tokyo-cyan" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="text-sm text-tokyo-text">Analyzing repository...</span>
        </div>
        <p class="text-xs text-tokyo-dimmed mt-4">
          This may take a moment for large repos.
        </p>
      </div>

      <!-- Error state -->
      <div id="scan-error" class="hidden">
        <div class="p-4 bg-tokyo-red/10 border border-tokyo-red/30 rounded-xl">
          <p class="text-sm text-tokyo-red font-medium mb-1">Scan failed</p>
          <p id="scan-error-msg" class="text-xs text-tokyo-dimmed"></p>
        </div>
      </div>

      <!-- Result state -->
      <div id="scan-result" class="hidden">
        <div class="p-6 rounded-xl bg-tokyo-surface/60 border border-tokyo-border/30 backdrop-blur-sm">
          <!-- Header: AI% as hero metric -->
          <div class="text-center mb-5">
            <h3 id="result-repo" class="text-xl font-bold text-tokyo-text mb-3"></h3>
            <div class="text-5xl font-bold text-[#f7768e] mb-1" id="result-ai-pct-hero"></div>
            <p class="text-sm text-tokyo-dimmed">AI-generated commits</p>
            <p class="text-xs text-tokyo-dimmed mt-1">
              <span id="result-commits"></span> commits analyzed
            </p>
          </div>

          <!-- AI vs Human bar -->
          <div class="mb-5">
            <div class="flex items-center justify-between text-xs mb-1.5">
              <span class="text-[#f7768e]">AI <span id="result-ai-count"></span> (<span id="result-ai-pct"></span>%)</span>
              <span class="text-[#7aa2f7]">(<span id="result-human-pct"></span>%) <span id="result-human-count"></span> Human</span>
            </div>
            <div class="h-4 bg-[#7aa2f7]/30 rounded-full overflow-hidden relative">
              <div id="result-ai-bar" class="h-full rounded-full transition-all duration-1000 ease-out" style="width: 0%; background: linear-gradient(90deg, #f7768e, #ff9e64);"></div>
            </div>
          </div>

          <!-- Vibe Score + Grade (secondary) -->
          <div class="flex items-center justify-center gap-6 mb-5 p-4 rounded-xl bg-tokyo-bg/40 border border-tokyo-border/20">
            <div class="text-center">
              <p class="text-xs text-tokyo-dimmed mb-1">Vibe Score</p>
              <span id="result-score" class="text-2xl font-bold"></span>
            </div>
            <div class="h-10 w-px bg-tokyo-border/30"></div>
            <div class="text-center">
              <p class="text-xs text-tokyo-dimmed mb-1">Grade</p>
              <div id="result-grade" class="w-14 h-14 flex items-center justify-center rounded-xl text-2xl font-bold border-2"></div>
            </div>
          </div>

          <!-- Roast -->
          <p id="result-roast" class="text-sm text-tokyo-yellow italic mb-4"></p>

          <!-- Chaos Badges (colored pills) -->
          <div id="result-badges" class="flex flex-wrap gap-1.5 mb-4"></div>

          <!-- Languages -->
          <div id="result-langs" class="flex flex-wrap gap-1.5 mb-6"></div>

          <!-- Actions -->
          <div class="flex items-center gap-3">
            <a id="result-link" href="#" class="px-4 py-2 bg-tokyo-cyan/20 text-tokyo-cyan text-xs rounded-lg border border-tokyo-cyan/30 hover:bg-tokyo-cyan/30 transition-all">
              View full report &rarr;
            </a>
            <button id="result-share-twitter" class="px-4 py-2 bg-tokyo-surface text-tokyo-dimmed text-xs rounded-lg border border-tokyo-border/30 hover:text-tokyo-text transition-all">
              Share on Twitter
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Examples -->
    <div class="max-w-xl mx-auto mt-12">
      <p class="text-xs text-tokyo-dimmed mb-3">Try these:</p>
      <div class="flex flex-wrap gap-2">
        {['github:denoland/deno', 'github:astral-sh/ruff', 'github:tauri-apps/tauri'].map((example) => (
          <button
            class="scan-example px-3 py-1.5 bg-tokyo-surface/50 text-xs text-tokyo-dimmed border border-tokyo-border/30 rounded-lg hover:text-tokyo-text hover:border-tokyo-border/50 transition-all cursor-pointer"
            data-repo={example}
          >
            {example}
          </button>
        ))}
      </div>
    </div>
  </section>
</Base>

<script define:vars={{ apiUrl }}>
  const form = document.getElementById('scan-form');
  const input = document.getElementById('scan-input');
  const btn = document.getElementById('scan-btn');
  const statusArea = document.getElementById('scan-status');
  const loadingEl = document.getElementById('scan-loading');
  const errorEl = document.getElementById('scan-error');
  const errorMsg = document.getElementById('scan-error-msg');
  const resultEl = document.getElementById('scan-result');

  // Prefill from URL param
  const params = new URLSearchParams(window.location.search);
  const repoParam = params.get('repo');
  if (repoParam && input) {
    input.value = repoParam;
    // Auto-submit
    setTimeout(() => form?.dispatchEvent(new Event('submit')), 100);
  }

  // Example buttons
  document.querySelectorAll('.scan-example').forEach((el) => {
    el.addEventListener('click', () => {
      if (input) input.value = el.dataset.repo || '';
      form?.dispatchEvent(new Event('submit'));
    });
  });

  function showState(state) {
    statusArea?.classList.remove('hidden');
    loadingEl?.classList.add('hidden');
    errorEl?.classList.add('hidden');
    resultEl?.classList.add('hidden');

    if (state === 'loading') loadingEl?.classList.remove('hidden');
    if (state === 'error') errorEl?.classList.remove('hidden');
    if (state === 'result') resultEl?.classList.remove('hidden');
  }

  function getGradeClasses(grade) {
    if (!grade) return ['text-[#565f89]', 'bg-[#565f89]/20', 'border-[#565f89]/40'];
    const g = grade.charAt(0);
    switch (g) {
      case 'S': return ['text-[#9ece6a]', 'bg-[#9ece6a]/20', 'border-[#9ece6a]/40'];
      case 'A': return ['text-[#9ece6a]', 'bg-[#9ece6a]/20', 'border-[#9ece6a]/40'];
      case 'B': return ['text-[#7aa2f7]', 'bg-[#7aa2f7]/20', 'border-[#7aa2f7]/40'];
      case 'C': return ['text-[#e0af68]', 'bg-[#e0af68]/20', 'border-[#e0af68]/40'];
      case 'D': return ['text-[#f7768e]', 'bg-[#f7768e]/20', 'border-[#f7768e]/40'];
      default: return ['text-[#f7768e]', 'bg-red-500/20', 'border-red-500/40'];
    }
  }

  const langColors = {
    Rust: '#f7768e', TypeScript: '#7aa2f7', JavaScript: '#e0af68',
    Python: '#9ece6a', Go: '#7dcfff', Java: '#ff9e64',
    'C++': '#bb9af7', C: '#565f89', Ruby: '#f7768e', Swift: '#ff9e64',
  };

  // Badge color map: category -> [bg, text, border]
  const badgeStyles = {
    // Red: security issues
    'env-in-git':          { bg: 'rgba(247,118,142,0.15)', text: '#f7768e', border: 'rgba(247,118,142,0.3)', label: 'env in git' },
    'hardcoded-secrets':   { bg: 'rgba(247,118,142,0.15)', text: '#f7768e', border: 'rgba(247,118,142,0.3)', label: 'hardcoded secrets' },
    // Orange: bad practices
    'no-tests':            { bg: 'rgba(255,158,100,0.15)', text: '#ff9e64', border: 'rgba(255,158,100,0.3)', label: 'no tests' },
    'no-linting':          { bg: 'rgba(255,158,100,0.15)', text: '#ff9e64', border: 'rgba(255,158,100,0.3)', label: 'no linting' },
    'no-ci-cd':            { bg: 'rgba(255,158,100,0.15)', text: '#ff9e64', border: 'rgba(255,158,100,0.3)', label: 'no CI/CD' },
    // Purple: vibe patterns
    'boomer-ai':           { bg: 'rgba(187,154,247,0.15)', text: '#bb9af7', border: 'rgba(187,154,247,0.3)', label: 'boomer AI' },
    'node-modules':        { bg: 'rgba(187,154,247,0.15)', text: '#bb9af7', border: 'rgba(187,154,247,0.3)', label: 'node_modules' },
    'mega-commit':         { bg: 'rgba(187,154,247,0.15)', text: '#bb9af7', border: 'rgba(187,154,247,0.3)', label: 'mega commit' },
    // Gray: minor
    'todo-flood':          { bg: 'rgba(86,95,137,0.15)', text: '#565f89', border: 'rgba(86,95,137,0.3)', label: 'TODO flood' },
    'single-branch':       { bg: 'rgba(86,95,137,0.15)', text: '#565f89', border: 'rgba(86,95,137,0.3)', label: 'single branch' },
    'no-gitignore':        { bg: 'rgba(86,95,137,0.15)', text: '#565f89', border: 'rgba(86,95,137,0.3)', label: 'no .gitignore' },
    'no-readme':           { bg: 'rgba(86,95,137,0.15)', text: '#565f89', border: 'rgba(86,95,137,0.3)', label: 'no README' },
  };

  function renderBadges(container, badges) {
    container.innerHTML = '';
    if (!badges || badges.length === 0) return;
    for (const badge of badges) {
      const style = badgeStyles[badge] || { bg: 'rgba(86,95,137,0.15)', text: '#565f89', border: 'rgba(86,95,137,0.3)', label: badge.replace(/-/g, ' ') };
      const pill = document.createElement('span');
      pill.className = 'inline-block px-2.5 py-1 rounded-full text-xs font-medium';
      pill.style.cssText = `background:${style.bg}; color:${style.text}; border:1px solid ${style.border};`;
      pill.textContent = style.label;
      container.appendChild(pill);
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const repo = input?.value?.trim();
    if (!repo) return;

    btn.disabled = true;
    showState('loading');

    try {
      const res = await fetch(`${apiUrl}/api/scan`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ repo }),
      });

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.error || `Scan failed (${res.status})`);
      }

      const data = await res.json();
      const aiPct = Math.round((data.ai_ratio || 0) * 100);
      const humanPct = 100 - aiPct;

      // Populate result
      document.getElementById('result-repo').textContent = data.repo_name || repo;
      document.getElementById('result-commits').textContent = (data.total_commits || 0).toLocaleString();
      document.getElementById('result-ai-pct-hero').textContent = aiPct + '%';
      document.getElementById('result-ai-pct').textContent = String(aiPct);
      document.getElementById('result-human-pct').textContent = String(humanPct);
      document.getElementById('result-ai-count').textContent = (data.ai_commits || 0).toLocaleString();
      document.getElementById('result-human-count').textContent = (data.human_commits || 0).toLocaleString();
      document.getElementById('result-score').textContent = data.score || '0';
      document.getElementById('result-roast').textContent = `"${data.roast || 'No roast available.'}"`;

      // Grade badge (secondary)
      const gradeEl = document.getElementById('result-grade');
      const [textCls, bgCls, borderCls] = getGradeClasses(data.grade);
      gradeEl.className = `w-14 h-14 flex items-center justify-center rounded-xl text-2xl font-bold border-2 ${textCls} ${bgCls} ${borderCls}`;
      gradeEl.textContent = data.grade || '?';

      // Score color
      const scoreEl = document.getElementById('result-score');
      scoreEl.className = `text-2xl font-bold ${textCls}`;

      // AI bar animation (red=AI, blue background=Human)
      setTimeout(() => {
        document.getElementById('result-ai-bar').style.width = `${aiPct}%`;
      }, 100);

      // Chaos badges
      const badgesEl = document.getElementById('result-badges');
      renderBadges(badgesEl, data.chaos_badges || []);

      // Languages
      const langsEl = document.getElementById('result-langs');
      langsEl.innerHTML = '';
      if (data.languages) {
        Object.entries(data.languages)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5)
          .forEach(([lang, pct]) => {
            const chip = document.createElement('span');
            chip.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs bg-[#1a1b26]/80 text-[#565f89] border border-[#3b4261]/30';
            const color = langColors[lang] || '#565f89';
            chip.innerHTML = `<span class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></span>${lang} ${Math.round(pct)}%`;
            langsEl.appendChild(chip);
          });
      }

      // Links
      if (data.id) {
        document.getElementById('result-link').href = `/report?id=${data.id}`;
        document.getElementById('result-share-twitter').onclick = () => {
          const text = `My repo ${data.repo_name} scored ${data.grade} on vibereport! ${data.roast}`;
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.origin + '/report?id=' + data.id)}`, '_blank');
        };
      }

      showState('result');
    } catch (err) {
      errorMsg.textContent = err.message || 'An unexpected error occurred.';
      showState('error');
    } finally {
      btn.disabled = false;
    }
  });
</script>
