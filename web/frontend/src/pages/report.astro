---
import Base from '../layouts/Base.astro';
import { getApiUrl } from '../lib/api';

const apiUrl = getApiUrl();
---

<Base
  title="Vibe Report"
  description="Analyze any git repo and discover how much was AI-generated."
>
  <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-16">
    <!-- Back link -->
    <a
      href="/leaderboard"
      class="inline-flex items-center gap-1 text-xs text-tokyo-dimmed hover:text-tokyo-text transition-colors mb-8"
    >
      &larr; Back to leaderboard
    </a>

    <!-- Loading state -->
    <div id="report-loading" class="text-center py-20">
      <div class="inline-flex items-center gap-3 px-6 py-3 bg-tokyo-surface/50 rounded-xl border border-tokyo-border/30">
        <svg class="animate-spin h-5 w-5 text-tokyo-cyan" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-sm text-tokyo-text">Loading report...</span>
      </div>
    </div>

    <!-- Error state -->
    <div id="report-error" class="hidden text-center py-20">
      <div class="p-6 bg-tokyo-red/10 border border-tokyo-red/30 rounded-xl inline-block">
        <p class="text-sm text-tokyo-red font-medium mb-2">Report not found</p>
        <p class="text-xs text-tokyo-dimmed mb-4">This report may have been removed or the ID is invalid.</p>
        <a href="/" class="text-xs text-tokyo-cyan hover:text-tokyo-cyan/80 transition-colors">
          &larr; Go home
        </a>
      </div>
    </div>

    <!-- Report card (populated by JS) -->
    <div id="report-card" class="hidden rounded-2xl border border-tokyo-border/30 bg-tokyo-surface/50 backdrop-blur-sm overflow-hidden glow">
      <!-- Header -->
      <div class="px-6 sm:px-8 pt-8 pb-6 border-b border-tokyo-border/20">
        <p class="text-xs text-tokyo-dimmed uppercase tracking-wider mb-1">Vibe Report</p>
        <h1 id="rpt-name" class="text-xl sm:text-2xl font-bold text-tokyo-text"></h1>
        <p id="rpt-meta" class="text-xs text-tokyo-dimmed mt-1"></p>
      </div>

      <!-- Body -->
      <div class="px-6 sm:px-8 py-6 space-y-6">
        <!-- AI% hero -->
        <div class="text-center mb-6">
          <div id="rpt-ai-pct-label" class="text-5xl font-bold text-[#f7768e]"></div>
          <p class="text-sm text-tokyo-dimmed mt-1">AI-generated commits</p>
        </div>

        <!-- AI ratio bar -->
        <div>
          <div class="h-4 bg-tokyo-bg rounded-full overflow-hidden">
            <div id="rpt-ai-bar" class="h-full rounded-full transition-all duration-1000 ease-out" style="width: 0%; background: linear-gradient(90deg, #f7768e, #e0af68);"></div>
          </div>
          <div class="flex justify-between mt-1.5 text-xs text-tokyo-dimmed">
            <span id="rpt-ai-commits"></span>
            <span id="rpt-human-commits"></span>
          </div>
          <p id="rpt-total-commits" class="text-xs text-tokyo-dimmed mt-1"></p>
        </div>

        <!-- Vibe Score + Grade (secondary, side by side) -->
        <div class="flex items-center justify-center gap-6 p-4 rounded-xl bg-tokyo-bg/40 border border-tokyo-border/20 mb-6">
          <div class="text-center">
            <p class="text-xs text-tokyo-dimmed mb-1">Vibe Score</p>
            <span id="rpt-score" class="text-2xl font-bold"></span>
            <span class="text-sm text-tokyo-dimmed">/100</span>
          </div>
          <div class="h-10 w-px bg-tokyo-border/30"></div>
          <div class="text-center">
            <p class="text-xs text-tokyo-dimmed mb-1">Grade</p>
            <span id="rpt-grade-text" class="text-2xl font-bold"></span>
          </div>
        </div>

        <!-- Score Breakdown -->
        <div id="rpt-breakdown-section" class="hidden">
          <p class="text-xs text-tokyo-dimmed uppercase tracking-wider mb-3">Score Breakdown</p>
          <div id="rpt-breakdown" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Roast -->
        <div class="p-4 rounded-xl bg-tokyo-bg/60 border border-tokyo-border/20">
          <p class="text-xs text-tokyo-dimmed uppercase tracking-wider mb-2">Roast</p>
          <p id="rpt-roast" class="text-sm text-tokyo-yellow italic leading-relaxed"></p>
        </div>

        <!-- Languages -->
        <div id="rpt-langs-section" class="hidden">
          <p class="text-xs text-tokyo-dimmed uppercase tracking-wider mb-3">Languages</p>
          <div id="rpt-langs" class="space-y-2"></div>
        </div>
      </div>

      <!-- Footer / share -->
      <div class="px-6 sm:px-8 py-5 border-t border-tokyo-border/20 bg-tokyo-bg/30">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <p class="text-xs text-tokyo-dimmed">Share this report</p>
          <div class="flex items-center gap-2">
            <a id="share-twitter" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-tokyo-surface text-tokyo-dimmed text-xs rounded-lg border border-tokyo-border/30 hover:text-tokyo-text hover:border-tokyo-border/50 transition-all">
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              Twitter
            </a>
            <a id="share-reddit" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-tokyo-surface text-tokyo-dimmed text-xs rounded-lg border border-tokyo-border/30 hover:text-tokyo-text hover:border-tokyo-border/50 transition-all">
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
              </svg>
              Reddit
            </a>
            <button id="copy-link" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-tokyo-surface text-tokyo-dimmed text-xs rounded-lg border border-tokyo-border/30 hover:text-tokyo-text hover:border-tokyo-border/50 transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
              </svg>
              Copy link
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Base>

<script define:vars={{ apiUrl }}>
  const langColors = {
    Rust: '#f7768e', TypeScript: '#7aa2f7', JavaScript: '#e0af68',
    Python: '#9ece6a', Go: '#7dcfff', Java: '#ff9e64',
    'C++': '#bb9af7', C: '#565f89', Ruby: '#f7768e', Swift: '#ff9e64',
  };

  function getGradeColor(grade) {
    switch (grade) {
      case 'S': case 'A': return '#9ece6a';
      case 'B': return '#7aa2f7';
      case 'C': return '#e0af68';
      case 'D': case 'F': return '#f7768e';
      default: return '#c0caf5';
    }
  }

  function getScoreRoast(score) {
    if (score >= 200) return "This isn't a codebase, it's a cry for help.";
    if (score >= 190) return "You somehow made code worse than no code at all.";
    if (score >= 180) return "Every commit is a new war crime against software.";
    if (score >= 170) return "Your repo is a museum of bad decisions.";
    if (score >= 160) return "Even ChatGPT would refuse to touch this.";
    if (score >= 150) return "Your codebase needs therapy, not a code review.";
    if (score >= 140) return "The only thing tested here is everyone's patience.";
    if (score >= 130) return "Spaghetti code? This is a whole Italian restaurant.";
    if (score >= 120) return "You wrote code like you're speedrunning tech debt.";
    if (score >= 110) return "AI wrote this and even AI is embarrassed.";
    if (score >= 100) return "AI writes the code, nobody reviews it, and .env is in git. Ship it.";
    if (score >= 90) return "Your repo makes junior devs feel better about themselves.";
    if (score >= 80) return "This code was clearly written at 3 AM with no regrets.";
    if (score >= 70) return "Half AI, half hope, zero tests.";
    if (score >= 60) return "The vibes are… questionable.";
    if (score >= 50) return "Somewhere between 'it works' and 'why does it work?'";
    if (score >= 40) return "Not great, not terrible. Like 3.6 roentgen.";
    if (score >= 30) return "Slightly chaotic but still standing. Respect.";
    if (score >= 20) return "Pretty clean. Did a human actually write this?";
    if (score >= 10) return "Almost suspiciously well-maintained.";
    return "Pristine. Either you're lying or you have no life.";
  }

  async function loadReport() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (!id) {
      document.getElementById('report-loading').classList.add('hidden');
      document.getElementById('report-error').classList.remove('hidden');
      return;
    }

    try {
      const res = await fetch(`${apiUrl}/api/reports/${id}`);
      if (!res.ok) throw new Error('not found');
      const report = await res.json();

      const aiPct = Math.round((report.ai_ratio || 0) * 100);
      const color = getGradeColor(report.grade);

      // Header
      document.getElementById('rpt-name').textContent = report.repo_name;
      document.getElementById('rpt-meta').textContent =
        `${report.total_commits} commits | ${new Date(report.created_at).toLocaleDateString()}`;

      // AI% hero
      document.getElementById('rpt-ai-pct-label').textContent = `${aiPct}%`;

      // AI ratio bar
      setTimeout(() => {
        document.getElementById('rpt-ai-bar').style.width = `${aiPct}%`;
      }, 100);
      const aiCount = report.ai_commits || 0;
      const humanCount = (report.total_commits || 0) - aiCount;
      document.getElementById('rpt-ai-commits').textContent = `${aiCount.toLocaleString()} AI commits`;
      document.getElementById('rpt-human-commits').textContent = `${humanCount.toLocaleString()} human commits`;
      document.getElementById('rpt-total-commits').textContent =
        `${(report.total_commits || 0).toLocaleString()} commits analyzed`;

      // Score + grade (secondary)
      const scoreEl = document.getElementById('rpt-score');
      scoreEl.textContent = report.score;
      scoreEl.style.color = color;
      const gradeText = document.getElementById('rpt-grade-text');
      gradeText.textContent = report.grade;
      gradeText.style.color = color;

      // Roast
      document.getElementById('rpt-roast').textContent = `"${getScoreRoast(report.score)}"`;


      // Languages
      const langs = Object.entries(report.languages || {})
        .sort(([, a], [, b]) => b - a)
        .slice(0, 8);
      if (langs.length > 0) {
        document.getElementById('rpt-langs-section').classList.remove('hidden');
        const container = document.getElementById('rpt-langs');
        langs.forEach(([lang, pct]) => {
          const lc = langColors[lang] || '#565f89';
          const row = document.createElement('div');
          row.className = 'flex items-center gap-3';
          row.innerHTML = `
            <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color:${lc}"></span>
            <span class="text-sm text-[#c0caf5] w-24 flex-shrink-0">${lang}</span>
            <div class="flex-1 h-2 bg-[#1a1b26] rounded-full overflow-hidden">
              <div class="h-full rounded-full" style="width:${pct}%;background-color:${lc}"></div>
            </div>
            <span class="text-xs text-[#565f89] w-10 text-right tabular-nums">${Math.round(pct)}%</span>
          `;
          container.appendChild(row);
        });
      }

      // Score Breakdown
      const breakdown = [];
      const badges = report.chaos_badges || [];

      // AI ratio component (0-60 pts) — always present
      const aiRatioPts = Math.floor((report.ai_ratio || 0) * 60);
      if (aiRatioPts > 0) {
        breakdown.push({ label: `AI Ratio`, pts: aiRatioPts, bad: true });
      }

      // Tests — from has_tests field or chaos badge
      if (badges.includes('no-tests') || !report.has_tests) {
        breakdown.push({ label: 'No Tests', pts: 20, bad: true });
      }

      // .env in git
      if (badges.includes('env-in-git')) {
        breakdown.push({ label: '.env in Git', pts: 20, bad: true });
      }

      // No linting
      if (badges.includes('no-linting')) {
        breakdown.push({ label: 'No Linting', pts: 10, bad: true });
      }

      // No CI/CD
      if (badges.includes('no-ci-cd')) {
        breakdown.push({ label: 'No CI/CD', pts: 10, bad: true });
      }

      // Boomer AI
      if (badges.includes('boomer-ai')) {
        breakdown.push({ label: 'Boomer AI', pts: 10, bad: true });
      }

      // node_modules in git
      if (badges.includes('node-modules')) {
        breakdown.push({ label: 'node_modules in Git', pts: 15, bad: true });
      }

      // Mega commit
      if (badges.includes('mega-commit')) {
        breakdown.push({ label: 'Mega Commit', pts: 10, bad: true });
      }

      // No .gitignore
      if (badges.includes('no-gitignore')) {
        breakdown.push({ label: 'No .gitignore', pts: 10, bad: true });
      }

      // No README
      if (badges.includes('no-readme')) {
        breakdown.push({ label: 'No README', pts: 10, bad: true });
      }

      // TODO flood
      if (badges.includes('todo-flood')) {
        breakdown.push({ label: 'TODO Flood', pts: 5, bad: true });
      }

      // Single branch
      if (badges.includes('single-branch')) {
        breakdown.push({ label: 'Single Branch', pts: 5, bad: true });
      }

      // Deps bloat (0-10 pts)
      const depsCount = report.deps_count || 0;
      if (depsCount > 0) {
        const depsPts = Math.min(Math.floor(depsCount / 100 * 10), 10);
        if (depsPts > 0) {
          breakdown.push({ label: `${depsCount} Deps`, pts: depsPts, bad: true });
        }
      }

      // Good things (invert: show green pills for what's NOT in badges)
      if (report.has_tests && !badges.includes('no-tests')) {
        breakdown.push({ label: 'Has Tests', pts: 0, bad: false });
      }
      if (!badges.includes('no-linting') && badges.length > 0) {
        breakdown.push({ label: 'Has Linting', pts: 0, bad: false });
      }
      if (!badges.includes('no-ci-cd') && badges.length > 0) {
        breakdown.push({ label: 'Has CI/CD', pts: 0, bad: false });
      }

      if (breakdown.length > 0) {
        document.getElementById('rpt-breakdown-section').classList.remove('hidden');
        const bkContainer = document.getElementById('rpt-breakdown');
        breakdown.forEach(item => {
          const pill = document.createElement('span');
          if (item.bad) {
            pill.className = 'inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-[#f7768e]/10 text-[#f7768e]';
            pill.textContent = `${item.label} +${item.pts}`;
          } else {
            pill.className = 'inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-[#9ece6a]/10 text-[#9ece6a]';
            pill.textContent = `${item.label} \u2713`;
          }
          bkContainer.appendChild(pill);
        });
      }

      // Share links
      const url = window.location.href;
      const twitterText = `My repo ${report.repo_name} scored ${report.grade} on vibereport! "${report.roast}"`;
      document.getElementById('share-twitter').href =
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}&url=${encodeURIComponent(url)}`;
      const redditTitle = `vibereport: ${report.repo_name} scored ${report.grade} - "${report.roast}"`;
      document.getElementById('share-reddit').href =
        `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(redditTitle)}`;

      // Update page title
      document.title = `vibereport \u2014 ${report.repo_name} scored ${report.grade}!`;

      // Show report
      document.getElementById('report-loading').classList.add('hidden');
      document.getElementById('report-card').classList.remove('hidden');
    } catch {
      document.getElementById('report-loading').classList.add('hidden');
      document.getElementById('report-error').classList.remove('hidden');
    }
  }

  // Copy link
  document.getElementById('copy-link')?.addEventListener('click', () => {
    navigator.clipboard.writeText(window.location.href);
    const btn = document.getElementById('copy-link');
    if (btn) {
      const original = btn.innerHTML;
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
      setTimeout(() => { btn.innerHTML = original; }, 2000);
    }
  });

  loadReport();
</script>
