---
import Base from '../layouts/Base.astro';
import LeaderboardTable from '../components/LeaderboardTable.astro';
import { fetchLeaderboard, getApiUrl } from '../lib/api';

const page = 1;
const VALID_PERIODS = ['week', 'month'];
const VALID_SORTS = ['ai', 'score'];
const rawPeriod = Astro.url.searchParams.get('period');
const period = VALID_PERIODS.includes(rawPeriod) ? rawPeriod : undefined;
const rawSort = Astro.url.searchParams.get('sort');
const sort = VALID_SORTS.includes(rawSort) ? rawSort : 'score';
const limit = 50;

let leaderboard = { entries: [], total: 0, page: 1, limit: 50 };
try {
  leaderboard = await fetchLeaderboard(page, limit, period, sort);
} catch {}

const periods = [
  { value: undefined, label: 'All time' },
  { value: 'month', label: 'This month' },
  { value: 'week', label: 'This week' },
];

const periodSuffix = period ? `&period=${period}` : '';
const sortSuffix = sort !== 'score' ? `&sort=${sort}` : '';

const sortOptions = [
  { value: 'ai', label: 'AI %' },
  { value: 'score', label: 'Vibe Score' },
];

const apiUrl = getApiUrl();
const totalItems = leaderboard.total;
---

<Base title="Leaderboard - vibereport" description="See which repos have the highest vibe scores. The global leaderboard for AI-generated code detection.">
  <section class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-16">
    <!-- Header -->
    <div class="mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-tokyo-text mb-2">
        Leaderboard
      </h1>
      <p class="text-sm text-tokyo-dimmed">
        The most analyzed repos, ranked by vibe score.
      </p>
    </div>

    <!-- Period filters + Sort toggle -->
    <div class="flex flex-wrap items-center gap-x-6 gap-y-3 mb-8">
      <div class="flex items-center gap-2">
        {periods.map((p) => {
          const isActive = period === p.value;
          const href = p.value
            ? `/leaderboard?period=${p.value}${sortSuffix}`
            : `/leaderboard${sortSuffix ? `?${sortSuffix.slice(1)}` : ''}`;
          return (
            <a
              href={href}
              class:list={[
                'px-4 py-1.5 rounded-lg text-xs font-medium transition-all',
                isActive
                  ? 'bg-tokyo-cyan/20 text-tokyo-cyan border border-tokyo-cyan/30'
                  : 'bg-tokyo-surface/50 text-tokyo-dimmed border border-tokyo-border/30 hover:text-tokyo-text hover:border-tokyo-border/50',
              ]}
            >
              {p.label}
            </a>
          );
        })}
      </div>

      <div class="flex items-center gap-2">
        <span class="text-xs text-tokyo-dimmed">Sort by:</span>
        {sortOptions.map((s) => {
          const isActive = sort === s.value;
          const href = `/leaderboard?sort=${s.value}${periodSuffix}`;
          return (
            <a
              href={href}
              class:list={[
                'px-3 py-1.5 rounded-lg text-xs font-medium transition-all',
                isActive
                  ? 'bg-tokyo-cyan/10 text-tokyo-cyan border border-tokyo-cyan/30'
                  : 'bg-tokyo-surface/50 text-tokyo-dimmed border border-tokyo-border/30 hover:text-tokyo-text hover:border-tokyo-border/50',
              ]}
            >
              {s.label}
            </a>
          );
        })}
      </div>
    </div>

    <!-- Table -->
    <div class="rounded-xl border border-tokyo-border/30 bg-tokyo-surface/30 backdrop-blur-sm overflow-hidden mb-8">
      <LeaderboardTable
        entries={leaderboard.entries}
        startRank={1}
      />
    </div>

    <!-- Loading spinner (hidden by default) -->
    <div id="loading-spinner" class="hidden flex justify-center py-6">
      <svg class="animate-spin h-6 w-6 text-tokyo-cyan" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>

    <!-- Sentinel for IntersectionObserver -->
    <div id="scroll-sentinel"></div>
  </section>
</Base>

<script define:vars={{ apiUrl, period, sort, limit, totalItems }}>
  (function() {
    let currentPage = 1;
    let loading = false;
    let allLoaded = totalItems <= limit;

    const tbody = document.querySelector('.w-full.text-sm tbody');
    const spinner = document.getElementById('loading-spinner');
    const sentinel = document.getElementById('scroll-sentinel');

    if (!tbody || !sentinel) return;

    function gradeColor(grade) {
      if (grade.startsWith('S')) return 'text-tokyo-green';
      if (grade.startsWith('A')) return 'text-tokyo-green';
      if (grade.startsWith('B')) return 'text-tokyo-cyan';
      if (grade.startsWith('C')) return 'text-tokyo-yellow';
      if (grade.startsWith('D')) return 'text-tokyo-red';
      if (grade === 'F') return 'text-red-500';
      return 'text-tokyo-text';
    }

    function rankEmoji(rank) {
      if (rank === 1) return '\u{1F947}';
      if (rank === 2) return '\u{1F948}';
      if (rank === 3) return '\u{1F949}';
      return '#' + rank;
    }

    function createRow(entry, rank) {
      const aiPercent = Math.round(entry.ai_ratio * 100);
      const colorClass = gradeColor(entry.grade);
      const repoName = entry.repo_name || entry.github_username;

      const tr = document.createElement('tr');
      tr.className = 'border-b border-tokyo-border/20 hover:bg-tokyo-surface/50 transition-colors group';

      // Rank cell
      const tdRank = document.createElement('td');
      tdRank.className = 'py-3 px-3 text-tokyo-dimmed font-medium';
      const rankSpan = document.createElement('span');
      rankSpan.className = rank <= 3 ? 'text-base' : 'text-sm';
      rankSpan.textContent = rankEmoji(rank);
      tdRank.appendChild(rankSpan);
      tr.appendChild(tdRank);

      // Repo name cell
      const tdName = document.createElement('td');
      tdName.className = 'py-3 px-3';
      const nameLink = document.createElement('a');
      nameLink.href = '/report?id=' + encodeURIComponent(entry.id);
      nameLink.className = 'text-tokyo-text hover:text-tokyo-cyan transition-colors font-medium';
      nameLink.textContent = repoName;
      tdName.appendChild(nameLink);
      tr.appendChild(tdName);

      // AI% bar cell
      const tdAi = document.createElement('td');
      tdAi.className = 'py-3 px-3 text-center';
      const aiWrapper = document.createElement('div');
      aiWrapper.className = 'flex items-center justify-center gap-2';
      const barOuter = document.createElement('div');
      barOuter.className = 'w-16 h-1.5 bg-tokyo-bg rounded-full overflow-hidden hidden sm:block';
      const barInner = document.createElement('div');
      barInner.className = 'h-full rounded-full';
      barInner.style.width = Math.min(Math.max(aiPercent, 0), 100) + '%';
      barInner.style.background = 'linear-gradient(90deg, #f7768e, #e0af68)';
      barOuter.appendChild(barInner);
      aiWrapper.appendChild(barOuter);
      const aiLabel = document.createElement('span');
      aiLabel.className = 'text-tokyo-dimmed text-xs tabular-nums';
      aiLabel.textContent = aiPercent + '%';
      aiWrapper.appendChild(aiLabel);
      tdAi.appendChild(aiWrapper);
      tr.appendChild(tdAi);

      // Score points cell
      const tdScore = document.createElement('td');
      tdScore.className = 'py-3 px-3 text-center';
      const scoreSpan = document.createElement('span');
      scoreSpan.className = 'text-xs text-tokyo-dimmed tabular-nums';
      scoreSpan.textContent = entry.score_points;
      tdScore.appendChild(scoreSpan);
      tr.appendChild(tdScore);

      // Grade cell
      const tdGrade = document.createElement('td');
      tdGrade.className = 'py-3 px-3 text-center';
      const gradeSpan = document.createElement('span');
      gradeSpan.className = 'font-bold ' + colorClass;
      gradeSpan.textContent = entry.score_grade;
      tdGrade.appendChild(gradeSpan);
      tr.appendChild(tdGrade);

      return tr;
    }

    async function loadMore() {
      if (loading || allLoaded) return;
      loading = true;
      spinner.classList.remove('hidden');

      const nextPage = currentPage + 1;
      const params = new URLSearchParams({ page: String(nextPage), limit: String(limit) });
      if (period) params.set('period', period);
      if (sort) params.set('sort', sort);

      try {
        const res = await fetch(`${apiUrl}/api/leaderboard?${params}`);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        const reports = data.reports || [];

        if (reports.length === 0) {
          allLoaded = true;
        } else {
          const startRank = currentPage * limit + 1;
          reports.forEach((entry, i) => {
            tbody.appendChild(createRow(entry, startRank + i));
          });
          currentPage = nextPage;

          if (reports.length < limit) {
            allLoaded = true;
          }
        }
      } catch (err) {
        console.error('Leaderboard fetch error:', err);
      } finally {
        loading = false;
        spinner.classList.add('hidden');
      }
    }

    if (!allLoaded) {
      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !allLoaded) {
          loadMore();
        }
      }, { rootMargin: '200px' });

      observer.observe(sentinel);
    }
  })();
</script>
