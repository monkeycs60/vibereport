---
interface Props {
  trends: Array<{
    month: string;
    total_commits: number;
    ai_commits: number;
    total_scans: number;
  }>;
}

const { trends } = Astro.props;

// Filter months that have commit data
const data = trends
  .map(t => ({
    month: t.month,
    ai: t.ai_commits || 0,
    human: (t.total_commits || 0) - (t.ai_commits || 0),
    total: t.total_commits || 0,
  }))
  .filter(d => d.total > 0);

// Chart dimensions
const viewW = 800;
const viewH = 300;
const chartLeft = 60;
const chartRight = 780;
const chartTop = 20;
const chartBottom = 240;
const chartW = chartRight - chartLeft;
const chartH = chartBottom - chartTop;

// Find max for Y scale
const maxCommits = Math.max(...data.map(d => d.total), 1);

// Bar width with gap
const barWidth = data.length > 0 ? Math.min(chartW / data.length * 0.7, 60) : 40;
const barGap = data.length > 0 ? chartW / data.length : 0;

// Format month label: "2025-06" -> "Jun 25"
const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
function formatMonth(m: string): string {
  const parts = m.split('-');
  const monthIdx = parseInt(parts[1], 10) - 1;
  const yearShort = parts[0].slice(2);
  return `${monthNames[monthIdx]} ${yearShort}`;
}

// Format number with K/M suffix
function formatNum(n: number): string {
  if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
  if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
  return String(n);
}

// Y-axis labels (4 ticks)
const yTicks = [0, 0.25, 0.5, 0.75, 1].map(pct => Math.round(maxCommits * pct));

// Compute global totals for the header
const totalAi = data.reduce((s, d) => s + d.ai, 0);
const totalHuman = data.reduce((s, d) => s + d.human, 0);
const totalAll = totalAi + totalHuman;
const aiPercent = totalAll > 0 ? Math.round(totalAi / totalAll * 100) : 0;
---

<div class="w-full overflow-hidden rounded-xl border border-tokyo-border/30 bg-tokyo-surface/30 p-4">
  <!-- Header with totals -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-sm bg-[#f7768e] inline-block"></span>
        <span class="text-xs text-tokyo-dimmed">AI commits</span>
        <span class="text-sm font-bold text-[#f7768e]">{formatNum(totalAi)}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-sm bg-[#7aa2f7] inline-block"></span>
        <span class="text-xs text-tokyo-dimmed">Human commits</span>
        <span class="text-sm font-bold text-[#7aa2f7]">{formatNum(totalHuman)}</span>
      </div>
    </div>
    <span class="text-xs text-tokyo-dimmed">
      AI is winning <span class="text-[#f7768e] font-bold">{aiPercent}%</span> of commits
    </span>
  </div>

  {data.length > 0 ? (
    <svg viewBox={`0 0 ${viewW} ${viewH}`} class="w-full h-auto" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="aiBarGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#f7768e" stop-opacity="0.9" />
          <stop offset="100%" stop-color="#f7768e" stop-opacity="0.6" />
        </linearGradient>
        <linearGradient id="humanBarGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#7aa2f7" stop-opacity="0.9" />
          <stop offset="100%" stop-color="#7aa2f7" stop-opacity="0.6" />
        </linearGradient>
      </defs>

      {/* Grid lines */}
      {yTicks.map((val) => {
        const y = chartBottom - (val / maxCommits) * chartH;
        return (
          <g>
            <line
              x1={chartLeft}
              y1={y}
              x2={chartRight}
              y2={y}
              stroke="#3b4261"
              stroke-width="0.5"
              stroke-dasharray={val === 0 ? 'none' : '4,4'}
            />
            <text
              x={chartLeft - 8}
              y={y + 4}
              text-anchor="end"
              fill="#565f89"
              font-size="10"
              font-family="JetBrains Mono, monospace"
            >
              {formatNum(val)}
            </text>
          </g>
        );
      })}

      {/* Stacked bars */}
      {data.map((d, i) => {
        const cx = chartLeft + barGap * i + barGap / 2;
        const bx = cx - barWidth / 2;

        const humanH = (d.human / maxCommits) * chartH;
        const aiH = (d.ai / maxCommits) * chartH;

        // Human bar (bottom)
        const humanY = chartBottom - humanH;
        // AI bar (stacked on top)
        const aiY = humanY - aiH;

        // Month label
        const showEvery = data.length > 12 ? 3 : data.length > 6 ? 2 : 1;
        const showLabel = i % showEvery === 0 || i === data.length - 1;

        return (
          <g class="battle-bar">
            {/* Human portion */}
            {d.human > 0 && (
              <rect
                x={bx}
                y={humanY}
                width={barWidth}
                height={humanH}
                rx="2"
                fill="url(#humanBarGrad)"
              />
            )}
            {/* AI portion */}
            {d.ai > 0 && (
              <rect
                x={bx}
                y={aiY}
                width={barWidth}
                height={aiH}
                rx="2"
                fill="url(#aiBarGrad)"
              />
            )}
            {/* Hover target */}
            <rect
              x={bx}
              y={chartTop}
              width={barWidth}
              height={chartH}
              fill="transparent"
              class="cursor-pointer"
            />
            {/* Month label */}
            {showLabel && (
              <text
                x={cx}
                y={chartBottom + 20}
                text-anchor="middle"
                fill="#565f89"
                font-size="9"
                font-family="JetBrains Mono, monospace"
              >
                {formatMonth(d.month)}
              </text>
            )}
          </g>
        );
      })}
    </svg>
  ) : (
    <p class="text-tokyo-dimmed text-sm text-center py-8">No commit data yet. Scan a repo to start the battle!</p>
  )}
</div>

<style>
  .battle-bar:hover rect[fill="url(#humanBarGrad)"] {
    filter: brightness(1.2);
  }
  .battle-bar:hover rect[fill="url(#aiBarGrad)"] {
    filter: brightness(1.2);
  }
</style>
