---
interface Props {
  indexAiCommits: number;
  indexHumanCommits: number;
  indexTotalRepos: number;
  indexSnapshotDate: string | null;
  communityAiCommits: number;
  communityHumanCommits: number;
  communityTotalRepos: number;
}

const {
  indexAiCommits, indexHumanCommits, indexTotalRepos, indexSnapshotDate,
  communityAiCommits, communityHumanCommits, communityTotalRepos,
} = Astro.props;

// Pre-compute both datasets as JSON for client-side toggle
const datasets = {
  index: {
    ai: indexAiCommits,
    human: indexHumanCommits,
    total: indexAiCommits + indexHumanCommits,
    repos: indexTotalRepos,
    label: indexSnapshotDate
      ? `Based on ${indexTotalRepos.toLocaleString()} top GitHub repos â€” updated ${indexSnapshotDate}`
      : `Based on ${indexTotalRepos.toLocaleString()} top GitHub repos`,
  },
  community: {
    ai: communityAiCommits,
    human: communityHumanCommits,
    total: communityAiCommits + communityHumanCommits,
    repos: communityTotalRepos,
    label: `Across ${communityTotalRepos.toLocaleString()} repos scanned by the community`,
  },
};

// Default to index if data available, else community
const defaultMode = indexAiCommits + indexHumanCommits > 0 ? 'index' : 'community';
const defaultData = datasets[defaultMode];
const aiPercent = defaultData.total > 0 ? (defaultData.ai / defaultData.total) * 100 : 0;
const humanPercent = defaultData.total > 0 ? 100 - aiPercent : 100;

function formatNum(n: number): string {
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(1)}K`;
  return String(n);
}

function getPhrase(pct: number): string {
  if (pct < 5) return 'Humans are winning... for now.';
  if (pct < 20) return 'The machines are gaining ground.';
  if (pct < 50) return "It's anyone's game.";
  return 'AI has taken over.';
}
---

<div class="tug-of-war w-full" id="tug-of-war" data-datasets={JSON.stringify(datasets)} data-default-mode={defaultMode}>
  <!-- Toggle -->
  <div class="flex items-center justify-center gap-0 mb-6">
    <button
      class:list={[
        'toggle-btn px-3 py-1.5 text-xs font-mono rounded-l-md border transition-all',
        defaultMode === 'index'
          ? 'bg-tokyo-cyan/20 text-tokyo-cyan border-tokyo-cyan/40'
          : 'bg-tokyo-surface/40 text-tokyo-dimmed border-tokyo-border/40 hover:text-tokyo-text',
      ]}
      data-mode="index"
    >
      GitHub Index
    </button>
    <button
      class:list={[
        'toggle-btn px-3 py-1.5 text-xs font-mono rounded-r-md border transition-all',
        defaultMode === 'community'
          ? 'bg-tokyo-cyan/20 text-tokyo-cyan border-tokyo-cyan/40'
          : 'bg-tokyo-surface/40 text-tokyo-dimmed border-tokyo-border/40 hover:text-tokyo-text',
      ]}
      data-mode="community"
    >
      Community
    </button>
  </div>

  <!-- Labels row -->
  <div class="flex items-center justify-between mb-4">
    <!-- AI side -->
    <div class="flex items-center gap-2.5">
      <span class="text-2xl sm:text-3xl">&#x1F916;</span>
      <div class="flex flex-col">
        <span class="text-sm sm:text-base font-bold text-[#f7768e]">AI</span>
        <span class="text-xs text-tokyo-dimmed font-mono" data-ai-count>{formatNum(defaultData.ai)} commits</span>
      </div>
    </div>

    <!-- Human side -->
    <div class="flex items-center gap-2.5">
      <div class="flex flex-col items-end">
        <span class="text-sm sm:text-base font-bold text-[#7aa2f7]">Humans</span>
        <span class="text-xs text-tokyo-dimmed font-mono" data-human-count>{formatNum(defaultData.human)} commits</span>
      </div>
      <span class="text-2xl sm:text-3xl">&#x1F9D1;</span>
    </div>
  </div>

  <!-- Tug-of-war bar -->
  <div class="bar-wrapper relative">
    <!-- Glow backdrop -->
    <div class="absolute inset-0 rounded-full blur-md opacity-40 pointer-events-none"
         style={`background: linear-gradient(to right, #f7768e 0%, #f7768e ${aiPercent}%, #7aa2f7 ${aiPercent}%, #7aa2f7 100%);`}>
    </div>

    <!-- Main bar container -->
    <div class="bar-container relative w-full h-8 sm:h-10 rounded-full overflow-hidden border border-tokyo-border/40 bg-tokyo-surface/60 backdrop-blur-sm">
      <!-- AI segment (left, red/pink) -->
      <div
        class="ai-bar absolute inset-y-0 left-0 rounded-l-full transition-all duration-[2000ms] ease-out"
        style="width: 0%;"
        data-target-width={`${aiPercent}%`}
      >
        <div class="w-full h-full bg-gradient-to-r from-[#f7768e] via-[#ff9cac] to-[#f7768e] relative overflow-hidden">
          <!-- Shimmer effect -->
          <div class="shimmer absolute inset-0"></div>
        </div>
        <!-- Percentage label on AI side -->
        {aiPercent >= 8 && (
          <span class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-bold text-white drop-shadow-md font-mono">
            {Math.round(aiPercent)}%
          </span>
        )}
      </div>

      <!-- Human segment (right, blue) -->
      <div
        class="human-bar absolute inset-y-0 right-0 rounded-r-full transition-all duration-[2000ms] ease-out"
        style="width: 0%;"
        data-target-width={`${humanPercent}%`}
      >
        <div class="w-full h-full bg-gradient-to-l from-[#7aa2f7] via-[#99b8f9] to-[#7aa2f7] relative overflow-hidden">
          <!-- Shimmer effect -->
          <div class="shimmer absolute inset-0"></div>
        </div>
        <!-- Percentage label on Human side -->
        {humanPercent >= 8 && (
          <span class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-bold text-white drop-shadow-md font-mono">
            {Math.round(humanPercent)}%
          </span>
        )}
      </div>

      <!-- Center divider line -->
      <div class="absolute inset-y-0 left-1/2 w-px bg-tokyo-dimmed/30 z-10 pointer-events-none"></div>
    </div>
  </div>

  <!-- Dynamic phrase -->
  <p class="battle-phrase text-center mt-5 text-sm sm:text-base text-tokyo-dimmed italic opacity-0 transition-opacity duration-1000 ease-in"
     id="battle-phrase">
    {getPhrase(aiPercent)}
  </p>

  <!-- Legend -->
  <p class="text-center mt-2 text-xs text-tokyo-dimmed/60 font-mono" id="battle-legend">
    {defaultData.label}
  </p>
</div>

<style>
  .tug-of-war {
    padding: 1.5rem;
    border-radius: 1rem;
    border: 1px solid rgba(59, 66, 97, 0.3);
    background: linear-gradient(
      135deg,
      rgba(36, 40, 59, 0.4) 0%,
      rgba(26, 27, 38, 0.6) 50%,
      rgba(36, 40, 59, 0.4) 100%
    );
    backdrop-filter: blur(12px);
  }

  /* Shimmer sweep animation */
  .shimmer {
    background: linear-gradient(
      110deg,
      transparent 30%,
      rgba(255, 255, 255, 0.12) 50%,
      transparent 70%
    );
    background-size: 200% 100%;
    animation: shimmer 3s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Subtle pulse on the bar wrapper glow */
  .bar-wrapper > div:first-child {
    animation: glow-pulse 4s ease-in-out infinite;
  }

  @keyframes glow-pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.5; }
  }
</style>

<script>
  function initTugOfWar() {
    const container = document.getElementById('tug-of-war');
    if (!container) return;

    const datasets = JSON.parse(container.dataset.datasets || '{}');
    let currentMode = container.dataset.defaultMode || 'index';
    let hasAnimated = false;

    const aiBar = container.querySelector('.ai-bar') as HTMLElement;
    const humanBar = container.querySelector('.human-bar') as HTMLElement;
    const phrase = document.getElementById('battle-phrase');
    const legend = document.getElementById('battle-legend');
    const aiLabel = container.querySelector('[data-ai-count]') as HTMLElement;
    const humanLabel = container.querySelector('[data-human-count]') as HTMLElement;

    function formatNum(n: number): string {
      if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
      if (n >= 1_000) return `${(n / 1_000).toFixed(1)}K`;
      return String(n);
    }

    function getPhrase(pct: number): string {
      if (pct < 5) return 'Humans are winning... for now.';
      if (pct < 20) return 'The machines are gaining ground.';
      if (pct < 50) return "It's anyone's game.";
      return 'AI has taken over.';
    }

    function updateBars(mode: string, animate: boolean) {
      const d = datasets[mode];
      if (!d || !aiBar || !humanBar) return;

      const aiPct = d.total > 0 ? (d.ai / d.total) * 100 : 0;
      const humanPct = d.total > 0 ? 100 - aiPct : 100;

      // Disable transition for instant toggle (after initial animation)
      if (!animate) {
        aiBar.style.transition = 'none';
        humanBar.style.transition = 'none';
      } else {
        aiBar.style.transition = '';
        humanBar.style.transition = '';
      }

      aiBar.style.width = `${aiPct}%`;
      humanBar.style.width = `${humanPct}%`;

      // Re-enable transitions after paint
      if (!animate) {
        requestAnimationFrame(() => {
          aiBar.style.transition = '';
          humanBar.style.transition = '';
        });
      }

      // Update percentage labels inside bars
      const aiPctLabel = aiBar.querySelector('span');
      const humanPctLabel = humanBar.querySelector('span');
      if (aiPctLabel) {
        if (aiPct >= 8) {
          aiPctLabel.textContent = `${Math.round(aiPct)}%`;
          aiPctLabel.style.display = '';
        } else {
          aiPctLabel.style.display = 'none';
        }
      }
      if (humanPctLabel) {
        if (humanPct >= 8) {
          humanPctLabel.textContent = `${Math.round(humanPct)}%`;
          humanPctLabel.style.display = '';
        } else {
          humanPctLabel.style.display = 'none';
        }
      }

      // Update commit counts
      if (aiLabel) aiLabel.textContent = `${formatNum(d.ai)} commits`;
      if (humanLabel) humanLabel.textContent = `${formatNum(d.human)} commits`;

      // Update phrase and legend
      if (phrase) phrase.textContent = getPhrase(aiPct);
      if (legend) legend.textContent = d.label;

      // Update glow backdrop
      const glowDiv = container.querySelector('.bar-wrapper > div:first-child') as HTMLElement;
      if (glowDiv) {
        glowDiv.style.background = `linear-gradient(to right, #f7768e 0%, #f7768e ${aiPct}%, #7aa2f7 ${aiPct}%, #7aa2f7 100%)`;
      }

      // Update toggle button styles
      container.querySelectorAll('.toggle-btn').forEach((btn) => {
        const el = btn as HTMLElement;
        const btnMode = el.dataset.mode;
        const rounding = btnMode === 'index' ? 'rounded-l-md' : 'rounded-r-md';
        if (btnMode === mode) {
          el.className = `toggle-btn px-3 py-1.5 text-xs font-mono ${rounding} border border-tokyo-cyan/40 bg-tokyo-cyan/20 text-tokyo-cyan transition-all`;
        } else {
          el.className = `toggle-btn px-3 py-1.5 text-xs font-mono ${rounding} border border-tokyo-border/40 bg-tokyo-surface/40 text-tokyo-dimmed hover:text-tokyo-text transition-all`;
        }
      });
    }

    // Toggle click handlers
    container.querySelectorAll('.toggle-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const mode = (btn as HTMLElement).dataset.mode || 'index';
        if (mode !== currentMode) {
          currentMode = mode;
          updateBars(mode, false);
        }
      });
    });

    // Initial animation on scroll
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !hasAnimated) {
            hasAnimated = true;
            requestAnimationFrame(() => updateBars(currentMode, true));
            if (phrase) {
              setTimeout(() => {
                phrase.classList.remove('opacity-0');
                phrase.classList.add('opacity-100');
              }, 1200);
            }
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2 }
    );

    observer.observe(container);
  }

  document.addEventListener('astro:page-load', initTugOfWar);
  initTugOfWar();
</script>
