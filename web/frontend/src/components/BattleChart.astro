---
interface Props {
  aiCommits: number;
  humanCommits: number;
  totalRepos: number;
  snapshotDate: string | null;
}

const { aiCommits, humanCommits, totalRepos, snapshotDate } = Astro.props;

const total = aiCommits + humanCommits;
const aiPercent = total > 0 ? (aiCommits / total) * 100 : 0;
const humanPercent = total > 0 ? 100 - aiPercent : 100;

function formatNum(n: number): string {
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(1)}K`;
  return String(n);
}

function getPhrase(pct: number): string {
  if (pct < 5) return 'Humans are winning... for now.';
  if (pct < 20) return 'The machines are gaining ground.';
  if (pct < 50) return "It's anyone's game.";
  return 'AI has taken over.';
}
---

<div class="tug-of-war w-full" id="tug-of-war">
  <!-- Labels row -->
  <div class="flex items-center justify-between mb-4">
    <!-- AI side -->
    <div class="flex items-center gap-2.5">
      <span class="text-2xl sm:text-3xl">&#x1F916;</span>
      <div class="flex flex-col">
        <span class="text-sm sm:text-base font-bold text-[#f7768e]">AI</span>
        <span class="text-xs text-tokyo-dimmed font-mono">{formatNum(aiCommits)} commits</span>
      </div>
    </div>

    <!-- Human side -->
    <div class="flex items-center gap-2.5">
      <div class="flex flex-col items-end">
        <span class="text-sm sm:text-base font-bold text-[#7aa2f7]">Humans</span>
        <span class="text-xs text-tokyo-dimmed font-mono">{formatNum(humanCommits)} commits</span>
      </div>
      <span class="text-2xl sm:text-3xl">&#x1F9D1;</span>
    </div>
  </div>

  <!-- Tug-of-war bar -->
  <div class="bar-wrapper relative">
    <!-- Glow backdrop -->
    <div class="absolute inset-0 rounded-full blur-md opacity-40 pointer-events-none"
         style={`background: linear-gradient(to right, #f7768e 0%, #f7768e ${aiPercent}%, #7aa2f7 ${aiPercent}%, #7aa2f7 100%);`}>
    </div>

    <!-- Main bar container -->
    <div class="bar-container relative w-full h-8 sm:h-10 rounded-full overflow-hidden border border-tokyo-border/40 bg-tokyo-surface/60 backdrop-blur-sm">
      <!-- AI segment (left, red/pink) -->
      <div
        class="ai-bar absolute inset-y-0 left-0 rounded-l-full transition-all duration-[2000ms] ease-out"
        style="width: 0%;"
        data-target-width={`${aiPercent}%`}
      >
        <div class="w-full h-full bg-gradient-to-r from-[#f7768e] via-[#ff9cac] to-[#f7768e] relative overflow-hidden">
          <!-- Shimmer effect -->
          <div class="shimmer absolute inset-0"></div>
        </div>
        <!-- Percentage label on AI side -->
        {aiPercent >= 8 && (
          <span class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-bold text-white drop-shadow-md font-mono">
            {Math.round(aiPercent)}%
          </span>
        )}
      </div>

      <!-- Human segment (right, blue) -->
      <div
        class="human-bar absolute inset-y-0 right-0 rounded-r-full transition-all duration-[2000ms] ease-out"
        style="width: 0%;"
        data-target-width={`${humanPercent}%`}
      >
        <div class="w-full h-full bg-gradient-to-l from-[#7aa2f7] via-[#99b8f9] to-[#7aa2f7] relative overflow-hidden">
          <!-- Shimmer effect -->
          <div class="shimmer absolute inset-0"></div>
        </div>
        <!-- Percentage label on Human side -->
        {humanPercent >= 8 && (
          <span class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-bold text-white drop-shadow-md font-mono">
            {Math.round(humanPercent)}%
          </span>
        )}
      </div>

      <!-- Center divider line -->
      <div class="absolute inset-y-0 left-1/2 w-px bg-tokyo-dimmed/30 z-10 pointer-events-none"></div>
    </div>
  </div>

  <!-- Dynamic phrase -->
  <p class="battle-phrase text-center mt-5 text-sm sm:text-base text-tokyo-dimmed italic opacity-0 transition-opacity duration-1000 ease-in"
     id="battle-phrase">
    {getPhrase(aiPercent)}
  </p>

  <!-- Full context legend -->
  <p class="text-center mt-2 text-xs text-tokyo-dimmed/60 font-mono leading-relaxed">
    {formatNum(aiCommits)} AI commits vs {formatNum(humanCommits)} human commits<br />
    across {totalRepos.toLocaleString()} top GitHub repos since Jan 2026 â€” updated daily
  </p>
</div>

<style>
  .tug-of-war {
    padding: 1.5rem;
    border-radius: 1rem;
    border: 1px solid rgba(59, 66, 97, 0.3);
    background: linear-gradient(
      135deg,
      rgba(36, 40, 59, 0.4) 0%,
      rgba(26, 27, 38, 0.6) 50%,
      rgba(36, 40, 59, 0.4) 100%
    );
    backdrop-filter: blur(12px);
  }

  /* Shimmer sweep animation */
  .shimmer {
    background: linear-gradient(
      110deg,
      transparent 30%,
      rgba(255, 255, 255, 0.12) 50%,
      transparent 70%
    );
    background-size: 200% 100%;
    animation: shimmer 3s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Subtle pulse on the bar wrapper glow */
  .bar-wrapper > div:first-child {
    animation: glow-pulse 4s ease-in-out infinite;
  }

  @keyframes glow-pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.5; }
  }
</style>

<script>
  function initTugOfWar() {
    const container = document.getElementById('tug-of-war');
    if (!container) return;

    const aiBar = container.querySelector('.ai-bar') as HTMLElement;
    const humanBar = container.querySelector('.human-bar') as HTMLElement;
    const phrase = document.getElementById('battle-phrase');

    if (aiBar) aiBar.style.width = aiBar.dataset.targetWidth || '0%';
    if (humanBar) humanBar.style.width = humanBar.dataset.targetWidth || '0%';

    if (phrase) {
      setTimeout(() => {
        phrase.classList.remove('opacity-0');
        phrase.classList.add('opacity-100');
      }, 1200);
    }
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          initTugOfWar();
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.2 }
  );

  const el = document.getElementById('tug-of-war');
  if (el) observer.observe(el);
</script>
