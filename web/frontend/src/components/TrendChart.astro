---
interface Props {
  snapshots: Array<{
    snapshot_date: string;
    total_commits: number;
    total_ai_commits: number;
    ai_percent: number;
  }>;
}

const { snapshots } = Astro.props;

// Chart dimensions
const viewW = 800;
const viewH = 250;
const chartLeft = 50;
const chartRight = 780;
const chartTop = 20;
const chartBottom = 200;
const chartW = chartRight - chartLeft;
const chartH = chartBottom - chartTop;

// Map data to coordinates
const points = snapshots.map((s, i) => {
  const x = snapshots.length === 1
    ? chartLeft + chartW / 2
    : chartLeft + (i / (snapshots.length - 1)) * chartW;
  const aiPct = Math.min(Math.max(s.ai_percent, 0), 100);
  const yAi = chartBottom - (aiPct / 100) * chartH;
  return { x, yAi, aiPct, date: s.snapshot_date };
});

// Build SVG paths for stacked areas (only with 2+ points)
let aiAreaPath = '';
let humanAreaPath = '';
let aiLinePath = '';

if (points.length >= 2) {
  // AI area: bottom to AI% line
  const forwardAi = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(1)},${p.yAi.toFixed(1)}`).join(' ');
  aiAreaPath = `${forwardAi} L${points[points.length - 1].x.toFixed(1)},${chartBottom} L${points[0].x.toFixed(1)},${chartBottom} Z`;

  // Human area: AI% line up to top (0% = chartTop, 100% = chartBottom)
  const forwardHuman = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(1)},${p.yAi.toFixed(1)}`).join(' ');
  humanAreaPath = `${forwardHuman} L${points[points.length - 1].x.toFixed(1)},${chartTop} L${points[0].x.toFixed(1)},${chartTop} Z`;

  // AI boundary line
  aiLinePath = forwardAi;
}

// Format date: "2026-02-21" -> "Feb 21"
const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
function formatDate(d: string): string {
  const parts = d.split('-');
  const monthIdx = parseInt(parts[1], 10) - 1;
  const day = parseInt(parts[2], 10);
  return `${monthNames[monthIdx]} ${day}`;
}

// Y-axis labels
const yLabels = [0, 25, 50, 75, 100];
---

<div class="w-full overflow-hidden rounded-xl border border-tokyo-border/30 bg-tokyo-surface/30 p-4">
  {snapshots.length >= 2 ? (
    <svg viewBox={`0 0 ${viewW} ${viewH}`} class="w-full h-auto" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="aiAreaGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#f7768e" stop-opacity="0.4" />
          <stop offset="100%" stop-color="#f7768e" stop-opacity="0.05" />
        </linearGradient>
        <linearGradient id="humanAreaGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#7aa2f7" stop-opacity="0.05" />
          <stop offset="100%" stop-color="#7aa2f7" stop-opacity="0.3" />
        </linearGradient>
      </defs>

      {/* Grid lines */}
      {yLabels.map((pct) => {
        const y = chartBottom - (pct / 100) * chartH;
        return (
          <line
            x1={chartLeft}
            y1={y}
            x2={chartRight}
            y2={y}
            stroke="#3b4261"
            stroke-width="0.5"
            stroke-dasharray={pct === 0 ? 'none' : '4,4'}
          />
        );
      })}

      {/* Y-axis labels */}
      {yLabels.map((pct) => {
        const y = chartBottom - (pct / 100) * chartH;
        return (
          <text
            x={chartLeft - 8}
            y={y + 4}
            text-anchor="end"
            fill="#565f89"
            font-size="10"
            font-family="JetBrains Mono, monospace"
          >
            {pct}%
          </text>
        );
      })}

      {/* Human area (top — blue) */}
      <path d={humanAreaPath} fill="url(#humanAreaGrad)" />

      {/* AI area (bottom — red/pink) */}
      <path d={aiAreaPath} fill="url(#aiAreaGrad)" />

      {/* AI boundary line */}
      <path d={aiLinePath} fill="none" stroke="#f7768e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />

      {/* Data point circles */}
      {points.map((p) => (
        <circle cx={p.x} cy={p.yAi} r="3.5" fill="#1a1b26" stroke="#f7768e" stroke-width="2" />
      ))}

      {/* X-axis date labels */}
      {points.map((p, i) => {
        const showEvery = snapshots.length > 14 ? 3 : snapshots.length > 7 ? 2 : 1;
        if (i % showEvery !== 0 && i !== snapshots.length - 1) return null;
        return (
          <text
            x={p.x}
            y={chartBottom + 20}
            text-anchor="middle"
            fill="#565f89"
            font-size="9"
            font-family="JetBrains Mono, monospace"
          >
            {formatDate(p.date)}
          </text>
        );
      })}

      {/* Area labels */}
      <text
        x={chartLeft + 10}
        y={chartTop + 18}
        fill="#7aa2f7"
        font-size="10"
        font-family="JetBrains Mono, monospace"
        opacity="0.7"
      >
        Human
      </text>
      <text
        x={chartLeft + 10}
        y={chartBottom - 8}
        fill="#f7768e"
        font-size="10"
        font-family="JetBrains Mono, monospace"
        opacity="0.7"
      >
        AI
      </text>
    </svg>
  ) : snapshots.length === 1 ? (
    <svg viewBox={`0 0 ${viewW} ${viewH}`} class="w-full h-auto" xmlns="http://www.w3.org/2000/svg">
      {/* Grid lines */}
      {yLabels.map((pct) => {
        const y = chartBottom - (pct / 100) * chartH;
        return (
          <line
            x1={chartLeft}
            y1={y}
            x2={chartRight}
            y2={y}
            stroke="#3b4261"
            stroke-width="0.5"
            stroke-dasharray={pct === 0 ? 'none' : '4,4'}
          />
        );
      })}

      {/* Y-axis labels */}
      {yLabels.map((pct) => {
        const y = chartBottom - (pct / 100) * chartH;
        return (
          <text
            x={chartLeft - 8}
            y={y + 4}
            text-anchor="end"
            fill="#565f89"
            font-size="10"
            font-family="JetBrains Mono, monospace"
          >
            {pct}%
          </text>
        );
      })}

      {/* Single data point */}
      <circle cx={points[0].x} cy={points[0].yAi} r="5" fill="#1a1b26" stroke="#f7768e" stroke-width="2.5" />
      <text
        x={points[0].x}
        y={points[0].yAi - 16}
        text-anchor="middle"
        fill="#f7768e"
        font-size="13"
        font-weight="bold"
        font-family="JetBrains Mono, monospace"
      >
        {points[0].aiPct.toFixed(1)}% AI — Day 1
      </text>
    </svg>
  ) : (
    <p class="text-tokyo-dimmed text-sm text-center py-8 font-mono">Day 1 of tracking</p>
  )}
</div>
